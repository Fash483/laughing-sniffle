name: Torrent Download & Upload to Pixeldrain

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  torrent-upload:
    runs-on: ubuntu-latest
    env:
      TORRENT_TORRENT_URL: 'https://itorrents.org/torrent/27F160798A82E23608607455EB4064309C99DD63.torrent'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install aria2c and Python dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2
          pip install torrentp

      - name: Download torrent file via aria2c
        run: |
          aria2c --dir=./torrent --out=file.torrent "$TORRENT_TORRENT_URL"

      - name: Download torrent content
        run: |
          torrentp --file ./torrent/file.torrent --save_path ./downloaded_files

      - name: Upload files to Pixeldrain
        run: |
          for file in ./downloaded_files/*; do
            filename=$(basename "$file")
            echo "Uploading $filename..."
            response=$(curl -s -F "file=@$file" https://pixeldrain.com/api/file)
            # Parse the response to get the download link
            url=$(echo $response | grep -oP '(?<="download_url":")[^"]+')
            echo "File uploaded: $url"
          done
